{"name":"Creating Surface Meshes with Freesurfer and Python","tagline":"freesurfer surface mri_surf2vol mni-space statistical map","body":"# Creating Surface Meshes with Freesurfer and Python\r\n\r\nThis ipython notebook is supposed to act as a basic tutorial for using freesurfer for surface extraction. As I do not own any rights regarding any of the functions nor data, please relate to the provided links and instructions which you can find there. \r\nPlease refer for more information with regards to plotting to: https://github.com/juhuntenburg\r\n\r\n## Introduction\r\nThis was created during the 2016 Brainhack in Paris, where I run into some issues with projecting statistical volume maps from fMRI analysis onto brain surfaces. The initial goal was to provide an example for the nilearn plot_surf_stat_map function using simple statistical maps in MNI space. This was more complex than expected, so this tutorial was created for those who just want to plot their analysis results onto a pretty surface. \r\n\r\n[Link to Tutorial](https://github.com/SRSteinkamp/PlottingSurfacesWithFreesurferAndPython/blob/master/Extracting_Surfaces_and_Plotting.ipynb)\r\n## Scope of the tutorial\r\n* Register your T1 map onto fsaverage\r\n* Create a mesh file of the surface and import it into freesurfer\r\n* Plot the mesh \r\n* Extract different fsaverage surfaces for visualization\r\n* Small example of nilearns plotting functions\r\n\r\n## Might be added later\r\n* loading meshes using nibabel form .gii, not using the vtk functions work around\r\n* a nipype implementation (for python 3.4+), so that there is no need for using freesurfer seperately\r\n\r\n\r\n# Short Tutorial to Prepare Surfaces for nilearn's plot_surf_stat_map using Freesurfer\r\n\r\n## Things you have to do in Freesurfer to get to surface data\r\n\r\nThis is a small very un-pythonic tutorial for creating surface meshes of your statistical fMRI maps using the freesurfer suite. And plotting them using nilearn. Although the nipype package provides a good interface for all the common neuroimaging and analysis toolboxes, you might not be able to use it (e.g. there is no python3 support, yet).\r\n\r\nFreesurfer should be able to output surface files in gifti format, however nibabel seems not to recognize these files. Therefore the .vtk output format will be used, which has the advantage that it can easily be transformed to file formats used with common 3D applications. \r\n\r\nI do not provide the data used for this example here, however the results should be easily replicable and you basically need only one extra file. This example is only tested for the right hemisphere and the fsaverage, other subjects and hemispheres should be possible. \r\n\r\nThe most easiest way so far seems to use the vtk functions from the brainsurfacescripts collection: \r\nhttps://github.com/juhuntenburg/brainsurfacescripts\r\n\r\nThe statistical map for this example is from neurovault.org:\r\nhttp://neurovault.org/collections/723/\r\n\r\nAnd corresponds to the following paper: \r\nhttp://journal.frontiersin.org/article/10.3389/fnins.2014.00308/abstract\r\n\r\nNote: \r\nThis is already an example of the hopefully soon to come nilearn.plotting.plot_surf_stat_map function. More documentation and the nilearn git-hub forge containing the function can be found at https://github.com/juhuntenburg/, furthermore it is assumed that you have a working version of freesurfer on your system.\r\n\r\n\r\nSoftware and packages used:\r\n* http://freesurfer.net/\r\n* https://nilearn.github.io/\r\n* http://nipy.org/nibabel/\r\n* http://stanford.edu/~mwaskom/software/seaborn/\r\n\r\n\r\n```python\r\n# Load the necessary packages\r\n%matplotlib inline \r\nimport nibabel as nb # Nibabel for loading in imaging data\r\nfrom nilearn import plotting # Nilearn .plotting for all the nice plots\r\n\r\n# Data directory, adjust accordingly\r\ndata_dir = '/media/all_data/BRAINHACK/SurfacePlotting/'\r\n\r\n# The name of the statistical map\r\nstat_map_file = data_dir  + '/spmT_0001_HEminLE.nii.gz'\r\nstat_map = nb.load(stat_map_file)\r\n\r\n# Plot an unthresholded map of your file\r\nplot = plotting.plot_stat_map(stat_map)\r\n```\r\n\r\n    /usr/lib/python3/dist-packages/matplotlib/collections.py:571: FutureWarning: elementwise comparison failed; returning scalar instead, but in the future will perform elementwise comparison\r\n      if self._edgecolors == str('face'):\r\n\r\n\r\n![](https://raw.githubusercontent.com/SRSteinkamp/PlottingSurfacesWithFreesurferAndPython/master/page/output_2_1.png)\r\n\r\n\r\n### Preparing Statistical Map\r\n\r\nIn a first step you have to register your statistical map onto your subject. This is done by mri_vol2surf.\r\n\r\n    mri_vol2surf --src $YOUR_DIR/YOUR_STATMAP.nii --hemi rh  --float2int round --o YOUR_STATMAP_OUT.mgz --projfrac 0.5 --trgsubject fsaverage --regheader fsaverage  \r\n\r\nIn this example the T-map in MNI space is mapped onto the right hemisphere of the fsaverage subject. \r\n* --src is the source file, your statistical map\r\n* --hemi defines the hemisphere rh for right, lh for left\r\n* --o defines the output file and output directory, output is by default into source directory\r\n* --trgsubject defines the subject onto which the statistical map should be registered, uses your SUBJECTS_DIR directory by default\r\n* --regheader uses the subject header for registration information\r\n* --projfrac from the freesurfer documentation: \"fraction (0,1) of the cortical thickness at each vertex to project along the surface normal. Default=0. When set at 0.5 with the white surface, this should sample in the middle of the cortical surface. This requires that a ?h.thickness file exist for the source subject. Note, the faction can be less than zero, in which case it will project into the white matter. See also --projdist.\"\r\n\r\n* --float2int from freesurfer documentation: \"Override float2int method in registration file. See BUGS.\" \r\n\r\nThe new surface file needs to be transformed into ascii. The vtk file format is the format of choice here. As mri_vol2surf outputs a 1 dimensional curvature file, you also need to add a surface file which provides the coordinates for each value. \r\n\r\n    mris_convert -c $YOUR_DIR/YOUR_STATMAP_OUT.mgz $FREESURFER_HOME/subjects/fsaverage/surf/rh.orig  $YOUR_DIR/YOUR_STATMAP_OUT.vtk\r\n\r\nThe first and last entry are as above, the second entry defines the reference surface onto which the statistical map was projected. Freesurfer adds a 'rh.' or 'lh.' automatically to the beginning of the file, depending on what hemisphere you extracted if you use the --c flag.\r\n\r\n\r\n## Loading the data using the vtk_tools\r\n\r\n\r\n```python\r\nfrom vtk_rw import read_vtk\r\n\r\nrh_stat = data_dir + 'rh.stat_map.vtk'\r\n\r\nvertices_stat, faces_stat, data_stat = read_vtk(rh_stat)\r\n\r\nmesh_stat = {'coords':vertices_stat, 'faces':faces_stat}\r\n\r\n```\r\n\r\n## Plot original surface:\r\n\r\nThe basic information for the meshes is already in file exported by freesurfer. \r\n\r\n\r\n```python\r\nimport seaborn as sns\r\nfrom nilearn import plotting\r\nsns.set_style('white')\r\nsns.set_context('poster')\r\n\r\nplot = plotting.plot_surf_stat_map(mesh_stat, 'rh', figsize = (15, 10))\r\n\r\n\r\n```\r\n\r\n    /usr/lib/python3/dist-packages/matplotlib/collections.py:571: FutureWarning: elementwise comparison failed; returning scalar instead, but in the future will perform elementwise comparison\r\n      if self._edgecolors == str('face'):\r\n\r\n\r\n\r\n![](https://raw.githubusercontent.com/SRSteinkamp/PlottingSurfacesWithFreesurferAndPython/master/page/output_7_1.png)\r\n\r\n## Adding the statistical map\r\nAs you can see the value for the faces is also provided in the surfaces file.\r\n\r\n\r\n```python\r\nplot = plotting.plot_surf_stat_map(mesh_stat, 'rh' ,stat_map = data_stat, threshold = 0,  figsize = (15, 10))\r\n```\r\n\r\n    /usr/lib/python3/dist-packages/matplotlib/collections.py:571: FutureWarning: elementwise comparison failed; returning scalar instead, but in the future will perform elementwise comparison\r\n      if self._edgecolors == str('face'):\r\n\r\n\r\n![](https://raw.githubusercontent.com/SRSteinkamp/PlottingSurfacesWithFreesurferAndPython/master/page/output_9_1.png)\r\n\r\n\r\n## Getting Curvature data:\r\n\r\nTo extract the curvature file of the average subject you basically need to run a similiar command as for the extraction of the surface data of the statitical map.\r\n\r\n    mris_convert -c $FREESURFER_HOME/subjects/fsaverage/surf/rh.curv $FREESURFER_HOME/subjects/fsaverage/surf/rh.orig  $YOUR_DIR/YOUR_CURVATURE_OUT.vtk\r\n    \r\n\r\n\r\n\r\n```python\r\nrh_curv = data_dir + 'rh.rh_curvature.vtk'\r\n\r\nvertices_curv, faces_curv, data_curv = read_vtk(rh_curv) \r\n# We only need the data for the curvature\r\n\r\nplot = plotting.plot_surf_stat_map(mesh_stat, 'rh' ,stat_map = data_stat, bg_map = data_curv, threshold = 1,  figsize = (15, 10))\r\n\r\n```\r\n\r\n    /usr/lib/python3/dist-packages/matplotlib/collections.py:571: FutureWarning: elementwise comparison failed; returning scalar instead, but in the future will perform elementwise comparison\r\n      if self._edgecolors == str('face'):\r\n\r\n\r\n![](https://raw.githubusercontent.com/SRSteinkamp/PlottingSurfacesWithFreesurferAndPython/master/page/output_12_1.png)\r\n\r\n\r\n## Plotting on the inflated surface\r\n\r\nYou can also extract the inflated brain mesh of the subject:\r\n\r\n    mris_convert  $FREESURFER_HOME/subjects/fsaverage/surf/rh.inflated  $YOUR_DIR/YOUR_INFLATED_OUT.vtk\r\n\r\n\r\n```python\r\nrh_inflated = data_dir + 'rh_inflated.vtk'\r\n\r\nvertices_inflated, faces_inflated, data_inflated = read_vtk(rh_inflated)\r\n\r\nmesh_inflated = {'coords':vertices_inflated, 'faces':faces_inflated}\r\n\r\n```\r\n\r\n\r\n```python\r\nplot = plotting.plot_surf_stat_map(mesh_inflated, 'rh' ,stat_map = data_stat, bg_map = data_curv, threshold = 1,  figsize = (15, 10))\r\n\r\n```\r\n\r\n    /usr/lib/python3/dist-packages/matplotlib/collections.py:571: FutureWarning: elementwise comparison failed; returning scalar instead, but in the future will perform elementwise comparison\r\n      if self._edgecolors == str('face'):\r\n\r\n\r\n![](https://raw.githubusercontent.com/SRSteinkamp/PlottingSurfacesWithFreesurferAndPython/master/page/output_15_1.png)\r\n\r\n\r\n## Polygon reduction\r\n\r\nA note of caution here: the extracted meshes are very detailed and take a long time to render, so you might want to decrease the number of polygons. This can be done with some free-software. Meshlabs and Blender3D being the most obivous choices. ","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}